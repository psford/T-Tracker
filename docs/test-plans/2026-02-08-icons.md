# Human Test Plan: Vehicle Icons Feature

**Date:** 2026-02-08
**Feature:** Replace arrow markers with type-specific vehicle icon silhouettes
**Branch:** feature/icons

---

## Prerequisites

- Local HTTP server running: `python -m http.server 8000` from project root
- App accessible at `http://localhost:8000`
- `config.js` present with valid MBTA API key (copied from `config.example.js`)
- Automated tests passing:
  - `node --experimental-vm-modules tests/vehicle-icons.test.js` (12 assertions, all pass)
  - `node --experimental-vm-modules tests/vehicles.test.js` (6 test groups, all pass)
- Browser with DevTools available (Chrome or Firefox recommended)
- MBTA service hours (vehicles must be active on the network)

---

## Phase 1: Icon Rendering and Silhouette Verification

**Covers:** icons.AC1.1, icons.AC1.2, icons.AC1.3, icons.AC1.4, icons.AC1.6

| Step | Action | Expected |
|------|--------|----------|
| 1.1 | Navigate to `http://localhost:8000`. Wait for the map to load and vehicles to appear (5-10 seconds for SSE data). | Map renders with dark CartoDB basemap. Vehicle markers appear on transit routes. |
| 1.2 | Zoom to the Green Line area (Kenmore Square / downtown Boston, around Boylston). Identify Green Line vehicle markers. | Green Line vehicles display a **trolley silhouette** with a visible pantograph pole extending upward from the roof, a rounded rectangular body, and four small rectangular windows. |
| 1.3 | Pan to a Red Line route area (e.g., Harvard, Kendall/MIT, Park Street). Identify Red Line vehicle markers. | Red Line vehicles display a **boxy angular subway car silhouette** with a continuous horizontal window band across the upper body and structural divider lines. Visually distinct from the Green Line trolley shape. |
| 1.4 | Verify Orange Line vehicles (e.g., near Downtown Crossing, Back Bay) and Blue Line vehicles (e.g., near Aquarium, Airport) also use the subway silhouette. | Orange and Blue Line vehicles use the same subway car shape as the Red Line (type 1 icon), but filled with their respective route colors (orange and blue). |
| 1.5 | In the route selection panel, enable "Commuter Rail" if not already visible. Zoom out to see Commuter Rail vehicles on a line (e.g., Framingham/Worcester, Providence). | Commuter Rail vehicles display a **taller coach silhouette** with an angled engine nose on the front (right side), a horizontal accent stripe across the lower body, and three windows above the stripe. Visually distinct from subway and trolley. |
| 1.6 | In the route selection panel, enable at least one Bus route. Zoom to an area with bus service. | Bus vehicles display a **bus silhouette** with a rounded arched top profile, a large windshield at the front (right side), visible wheel wells (lighter circles) with darker wheels inside, and a side window. Visually distinct from all rail types. |
| 1.7 | With Subway, Bus, and Commuter Rail all enabled, zoom to a level (around zoom 12) where multiple vehicle types are visible simultaneously. Assess whether each of the four active vehicle types has a recognizably different silhouette at 32px height. | Each vehicle type (trolley, subway, commuter rail, bus) is identifiable at a glance without needing to read popup text. The silhouettes have clearly different outlines. |

---

## Phase 2: Route Color Fill and Contrast

**Covers:** icons.AC2.1, icons.AC2.2, icons.AC2.3, icons.AC2.4

| Step | Action | Expected |
|------|--------|----------|
| 2.1 | Right-click a Red Line vehicle marker and select "Inspect" (or use DevTools Elements panel). Examine the `.vehicle-marker` div's inline style. | The wrapper div has `color: <hex-color>` in its inline style (e.g., a darkened red like `#b92318`). The `style` attribute also includes `--route-color: <same-hex>`. |
| 2.2 | In the Elements panel, expand the SVG inside the marker div. Examine `<rect>` elements that form the body shape. | Body shape elements have `fill="currentColor"`, which inherits the red color from the parent div's `color` property. |
| 2.3 | Compare a Red Line vehicle with a Green Line vehicle in the Elements panel. | The `color` property differs between the two (red vs green hex values). The body shapes render in their respective route colors. |
| 2.4 | Zoom in on any vehicle. Examine the SVG detail elements (windows, wheels, structural lines). | Windows appear as bright white/semi-transparent rectangles (`fill="rgba(255,255,255,0.85)"`). Wheels appear as dark circles (`fill="#333"`). Structural lines are subtle (`stroke="rgba(255,255,255,0.3)"`). All provide adequate contrast against the route-colored body. |
| 2.5 | At zoom level 10, zoom level 12, and zoom level 14, verify vehicle icons are clearly visible against the dark CartoDB basemap tiles. | At all three zoom levels, vehicle icons are clearly visible and recognizable. No icons blend into the dark background or become unreadable. |
| 2.6 | Inspect `getVehicleIconHtml()` in `src/map.js` (line 104). Verify the fallback color path exists. | Line 104 reads `const routeColor = routeColorMap.get(vehicle.routeId) \|\| '#888888';`. When `routeColorMap` lacks an entry for a route, the fallback gray color is applied. |
| 2.7 | (Optional) In browser console, execute: `document.querySelector('.vehicle-marker').style.color = '#888888'`. | The targeted vehicle icon body turns gray (#888888). The silhouette remains recognizable against the dark basemap. |

---

## Phase 3: Directional Rotation and Flip

**Covers:** icons.AC3.1, icons.AC3.3, icons.AC3.4, icons.AC3.5

| Step | Action | Expected |
|------|--------|----------|
| 3.1 | Find a north/south route (e.g., Red Line between Alewife and Braintree). Identify a northbound vehicle and a southbound vehicle on the same line. | Northbound vehicle's icon front points upward (tilted up-right). Southbound vehicle's icon front points downward (tilted down-right or down-left). They face opposite directions. |
| 3.2 | Find an east/west route segment (e.g., Green Line B/C/D heading west from Copley). Identify a westbound vehicle. | The westbound vehicle icon is **horizontally flipped** (front faces left, scaleX: -1). Wheels remain on the bottom of the icon (the icon is not upside-down). |
| 3.3 | Find an eastbound vehicle on the same route. | The eastbound vehicle icon faces right with no horizontal flip (scaleX: 1). Wheels remain on the bottom. |
| 3.4 | Watch a vehicle that is turning or following a curved route for 15-30 seconds (e.g., a bus route with turns, or Green Line near a bend). Pay attention to the moment the bearing crosses the 180-degree boundary (transitioning from facing right to facing left). | The scaleX flip transition is smooth or barely perceptible. There should be no abrupt visual "jump" or "snap." The 60fps bearing interpolation via `lerpAngle()` smooths the transition. If a brief flash is visible, assess whether it is acceptable. |
| 3.5 | Inspect a vehicle marker in DevTools. Examine the `.vehicle-marker` element's `style.transform`. | The transform value is in the form `scaleX(1) rotate(Ndeg)` or `scaleX(-1) rotate(Ndeg)`. The values update as the vehicle moves and its bearing changes. |

---

## Phase 4: Marker Sizing and Hit Area

**Covers:** icons.AC4.1, icons.AC4.2, icons.AC4.3, icons.AC4.5

| Step | Action | Expected |
|------|--------|----------|
| 4.1 | Inspect a vehicle marker in DevTools Elements panel. Find the Leaflet icon container div (the element with `style` containing dimensions). | The Leaflet `div` has computed width of 48px and height of 32px. The `.vehicle-marker` CSS also specifies `width: 48px; height: 32px`. The marker appears wider than it is tall. |
| 4.2 | In the same Elements panel, locate the `<svg>` element inside the marker div. | The `<svg>` element has attribute `viewBox="0 0 48 32"`. |
| 4.3 | Zoom in tightly on a vehicle (zoom level 16+). Assess whether the icon appears centered on the vehicle's reported geographic position. | The icon center aligns with the vehicle's position on the map. It does not appear offset to one side. The anchor point [24, 16] (center of the 48x32 rectangle) is correctly placing the icon. |
| 4.4 | Hover the mouse cursor over the **edge** of a vehicle icon (not the center). Try each corner of the rectangular marker bounds. | The popup triggers when hovering anywhere within the 48x32 rectangular bounds, including edges and corners, not just over the filled SVG area. |
| 4.5 | Open DevTools device toolbar. Set viewport to 390x844 (iPhone 14). Tap a vehicle icon on the mobile-simulated screen. | The popup appears on tap. Tap elsewhere to dismiss it. The 48x32 touch target is adequate for finger taps. |

---

## Phase 5: Icon Module Architecture (Code Inspection)

**Covers:** icons.AC5.3

| Step | Action | Expected |
|------|--------|----------|
| 5.1 | Open `src/map.js` in an editor. Search for any hardcoded SVG path data: `<path d=`, `<polygon points=`, `<rect x=`, `<circle cx=`. | The **only** hardcoded SVG element is the `ARROW_FALLBACK` constant on line 77 (`<polygon points="24,3 44,27 24,21 4,27" ...>`). No other SVG path data exists in map.js. All icon content is sourced from the imported `VEHICLE_ICONS` object. |
| 5.2 | Verify that map.js references icons only via `VEHICLE_ICONS[routeType]` and `DEFAULT_ICON`. | Line 105: `const iconSvg = VEHICLE_ICONS[routeType] \|\| DEFAULT_ICON \|\| ARROW_FALLBACK;`. This is the only place icon SVG content is selected. Changing an icon requires editing only `src/vehicle-icons.js`. |

---

## Phase 6: Cross-Cutting Regression

**Covers:** icons.AC6.1, icons.AC6.2, icons.AC6.3, icons.AC6.4, icons.AC6.5, icons.AC6.6

| Step | Action | Expected |
|------|--------|----------|
| 6.1 | With the app running at `http://localhost:8000`, watch vehicles for 10+ seconds. Observe the animation quality. | Vehicles animate smoothly along their routes with the new icon silhouettes. No jerky movement, no frozen markers, no flickering. |
| 6.2 | Zoom out so vehicles are near the edge of the viewport, then zoom back in. | Vehicles near the viewport edge fade in/out correctly. When zooming back in, vehicles reappear without visual artifacts. |
| 6.3 | Switch to another browser tab for 5 seconds, then return to the app tab. | Animation resumes without position jumps. Vehicles have moved to their updated positions smoothly (no teleportation to stale coordinates). |
| 6.4 | In the route selection panel, toggle "Subway" off. | All subway vehicle icons disappear from the map. Subway polylines also disappear. Bus and Commuter Rail vehicles (if enabled) remain. |
| 6.5 | Toggle "Subway" back on. | Subway vehicle icons reappear with correct type-specific silhouettes (trolley for Green Line, subway car for Red/Orange/Blue). They are not arrow markers. Polylines reappear. |
| 6.6 | Toggle "Bus" on, then off. | Only bus icons are affected. Rail icons remain. Polylines and icons appear/disappear together for bus routes. |
| 6.7 | Hover over a vehicle icon. | Popup appears above the icon with correct content (route name, direction, speed, status). Popup is positioned correctly relative to the 48x32 marker. |
| 6.8 | Move mouse away from the vehicle icon. | Popup closes. |
| 6.9 | Enable all route types (Subway, Bus, Commuter Rail). With many vehicles visible, observe animation smoothness for 10 seconds. | Animation remains smooth (target 60fps). No visible stuttering or lag with more complex SVG paths across many vehicles. |
| 6.10 | Open DevTools Performance tab. Click Record, wait 5 seconds, click Stop. Examine the flame chart. | No long frames (>50ms) attributed to paint or layout. No excessive forced reflow. Rendering performance is comparable to previous arrow markers. |
| 6.11 | Open DevTools device toolbar. Set viewport to 390x844 (iPhone 14). Tap a vehicle icon. | Popup appears on tap. Tap elsewhere to close. Touch target (48x32) is adequate -- larger than the previous 24x24. |
| 6.12 | Inspect `getVehicleIconHtml()` in `src/map.js`, line 105. | The fallback chain is: `VEHICLE_ICONS[routeType] \|\| DEFAULT_ICON \|\| ARROW_FALLBACK`. If both the type-specific icon and `DEFAULT_ICON` are falsy, the arrow polygon fallback renders. |
| 6.13 | Verify `ARROW_FALLBACK` on line 77 of map.js. | It is defined as `<polygon points="24,3 44,27 24,21 4,27" fill="currentColor" />`, scaled to fit the `0 0 48 32` viewBox. |

---

## End-to-End: Full Transit Network with Icons

**Purpose:** Validate that the complete data flow (MBTA API SSE data -> vehicle state management -> icon selection by route type -> color fill by route -> directional rotation by bearing -> Leaflet rendering) works correctly across all transit modes simultaneously.

**Steps:**

1. Navigate to `http://localhost:8000`. Wait for initial data load (routes, stops, SSE connection).
2. Enable all transit types in the route selection panel: Subway (all lines), Bus (select 2-3 routes), Commuter Rail (select 1-2 lines).
3. Verify that each transit mode displays its correct icon silhouette (trolley for Green Line, subway car for Red/Orange/Blue, coach for CR, bus for bus routes).
4. Verify that each vehicle is filled with its route's color (green for Green Line, red for Red Line, orange for Orange Line, blue for Blue Line, purple for Commuter Rail, and the bus route's assigned color).
5. Verify that vehicles face their direction of travel. Find northbound, southbound, eastbound, and westbound vehicles and confirm correct rotation and flip behavior.
6. Watch the map for 30 seconds. Confirm that all vehicle types animate smoothly along their routes without visual regressions.
7. Toggle several routes off and on. Confirm that icon type, color, and rotation are preserved across visibility changes.
8. Hover over one vehicle from each transit type. Confirm popups display correctly with route name, direction, speed, and status.

**Expected:** All transit modes render simultaneously with type-specific silhouettes, route-appropriate colors, correct directional rotation, smooth animation, and functioning popups. No regression from the previous arrow marker system.

---

## Human Verification Required

| Criterion | Why Manual | Steps |
|-----------|-----------|-------|
| icons.AC1.1 (human portion) | Trolley silhouette recognition (pantograph, rounded body, windows) is a perceptual judgment | Phase 1, Step 1.2 |
| icons.AC1.2 (human portion) | Subway car silhouette recognition (boxy shape, window band) is perceptual | Phase 1, Step 1.3 |
| icons.AC1.3 (human portion) | Commuter Rail coach recognition (taller body, engine nose, stripe) is perceptual | Phase 1, Step 1.5 |
| icons.AC1.4 (human portion) | Bus silhouette recognition (rounded top, windshield, wheel wells) is perceptual | Phase 1, Step 1.6 |
| icons.AC1.6 | Visual distinguishability at 32px on dark background is subjective | Phase 1, Step 1.7 |
| icons.AC2.1 | Route color fill applied at render time via CSS `color` property requires DOM inspection | Phase 2, Steps 2.1-2.3 |
| icons.AC2.2 | Accent contrast against colored body on dark background is perceptual | Phase 2, Step 2.4 |
| icons.AC2.3 | Visibility on dark CartoDB basemap at multiple zoom levels is perceptual | Phase 2, Step 2.5 |
| icons.AC2.4 | Fallback gray color rendering requires DOM manipulation or code inspection | Phase 2, Steps 2.6-2.7 |
| icons.AC3.1 (human portion) | Vehicle facing travel direction requires live animated data observation | Phase 3, Step 3.1 |
| icons.AC3.3 (human portion) | Westbound flip with wheels on bottom is a visual check | Phase 3, Step 3.2 |
| icons.AC3.4 (human portion) | Eastbound rotation with wheels on bottom is a visual check | Phase 3, Step 3.3 |
| icons.AC3.5 | Smooth transition at 180-degree flip boundary depends on animation rendering | Phase 3, Step 3.4 |
| icons.AC4.1 | Marker dimensions set via Leaflet divIcon, verified via DOM inspection | Phase 4, Step 4.1 |
| icons.AC4.2 | Anchor centering requires visual alignment against geographic position | Phase 4, Step 4.3 |
| icons.AC4.3 | SVG viewBox attribute verified via DOM inspection | Phase 4, Step 4.2 |
| icons.AC4.4 (human portion) | Consistent sizing across icon types requires visual comparison | Phase 1, Step 1.7 |
| icons.AC4.5 | Hit area coverage depends on browser layout and Leaflet event handling | Phase 4, Steps 4.4-4.5 |
| icons.AC5.3 | Architectural coupling is verified by code inspection of map.js | Phase 5, Steps 5.1-5.2 |
| icons.AC6.1 | Animation with new icons requires live rendering observation | Phase 6, Steps 6.1-6.3 |
| icons.AC6.2 | Visibility toggle with new markers requires live UI interaction | Phase 6, Steps 6.4-6.6 |
| icons.AC6.3 | Popup functionality with rectangular markers requires live hover testing | Phase 6, Steps 6.7-6.8 |
| icons.AC6.4 | Mobile touch targets require viewport simulation and tap testing | Phase 6, Step 6.11 |
| icons.AC6.5 | Performance with complex SVG paths requires profiling with real vehicle counts | Phase 6, Steps 6.9-6.10 |
| icons.AC6.6 | Fallback chain verified by code inspection of map.js | Phase 6, Steps 6.12-6.13 |

---

## Traceability

| Acceptance Criterion | Automated Test | Manual Step |
|----------------------|----------------|-------------|
| icons.AC1.1 | `vehicle-icons.test.js` `testType0Trolley()` + `testIconDistinctness()` | Phase 1, Step 1.2 |
| icons.AC1.2 | `vehicle-icons.test.js` `testType1Subway()` | Phase 1, Steps 1.3-1.4 |
| icons.AC1.3 | `vehicle-icons.test.js` `testType2CommuterRail()` | Phase 1, Step 1.5 |
| icons.AC1.4 | `vehicle-icons.test.js` `testType3Bus()` | Phase 1, Step 1.6 |
| icons.AC1.5 | `vehicle-icons.test.js` `testType4Ferry()` + `testIconDistinctness()` | N/A (future integration) |
| icons.AC1.6 | N/A | Phase 1, Step 1.7 |
| icons.AC1.7 | `vehicle-icons.test.js` `testDefaultFallback()` + `testFallbackExport()` | N/A |
| icons.AC2.1 | N/A | Phase 2, Steps 2.1-2.3 |
| icons.AC2.2 | N/A | Phase 2, Step 2.4 |
| icons.AC2.3 | N/A | Phase 2, Step 2.5 |
| icons.AC2.4 | N/A | Phase 2, Steps 2.6-2.7 |
| icons.AC3.1 | `vehicles.test.js` `testBearingToTransform()` (all 8 bearings) | Phase 3, Step 3.1 |
| icons.AC3.2 | `vehicles.test.js` `testBearingToTransform()` (bearing 90) | N/A |
| icons.AC3.3 | `vehicles.test.js` `testBearingToTransform()` (bearings 225, 270, 315) | Phase 3, Step 3.2 |
| icons.AC3.4 | `vehicles.test.js` `testBearingToTransform()` (bearings 0, 45, 135, 180) | Phase 3, Step 3.3 |
| icons.AC3.5 | N/A | Phase 3, Step 3.4 |
| icons.AC3.6 | `vehicles.test.js` `testBearingToTransform()` (bearing 0) | N/A |
| icons.AC3.7 | `vehicles.test.js` `testBearingToTransform()` (bearing 180) | N/A |
| icons.AC3.8 | `vehicles.test.js` `testBearingToTransform()` (null, undefined) | N/A |
| icons.AC4.1 | N/A | Phase 4, Step 4.1 |
| icons.AC4.2 | N/A | Phase 4, Step 4.3 |
| icons.AC4.3 | N/A | Phase 4, Step 4.2 |
| icons.AC4.4 | `vehicle-icons.test.js` `testVehicleIconsMapping()` | Phase 1, Step 1.7 |
| icons.AC4.5 | N/A | Phase 4, Steps 4.4-4.5 |
| icons.AC5.1 | `vehicle-icons.test.js` import + `testModuleStructure()` | N/A |
| icons.AC5.2 | `vehicle-icons.test.js` `testVehicleIconsMapping()` + `testExtensibility()` | N/A |
| icons.AC5.3 | N/A | Phase 5, Steps 5.1-5.2 |
| icons.AC5.4 | `vehicle-icons.test.js` `testFallbackExport()` + `testDefaultFallback()` | N/A |
| icons.AC5.5 | `vehicle-icons.test.js` `testExtensibility()` | N/A |
| icons.AC6.1 | N/A | Phase 6, Steps 6.1-6.3 |
| icons.AC6.2 | N/A | Phase 6, Steps 6.4-6.6 |
| icons.AC6.3 | N/A | Phase 6, Steps 6.7-6.8 |
| icons.AC6.4 | N/A | Phase 6, Step 6.11 |
| icons.AC6.5 | N/A | Phase 6, Steps 6.9-6.10 |
| icons.AC6.6 | N/A | Phase 6, Steps 6.12-6.13 |
