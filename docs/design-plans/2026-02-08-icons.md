# Transit Vehicle Icons Design

## Summary

Replace the generic colored arrow markers with five distinctive side-view SVG vehicle silhouettes (trolley, subway car, commuter rail coach, bus, ferry) stored in a dedicated icon module (`src/vehicle-icons.js`). Icons are filled with route color, accented with realistic details, and rotate naturally to show direction of travel. Marker size increases from 24x24 to 48x32 (rectangular). Rotation logic flips icons horizontally when heading leftward so vehicles always appear to travel along the track with wheels down. Icon artwork is separated from rendering logic for easy iteration and seasonal variants.

## Definition of Done

Replace the current colored arrow polygon markers with five distinctive inline SVG vehicle silhouettes (trolley, subway car, commuter rail coach, bus, ferry). Each icon is a recognizable side-view profile at 32px height, filled with the route color and accented with realistic details (windows, wheels, etc.). Icons rotate naturally to show direction of travel, flipping horizontally when heading leftward so they never appear upside-down. Marker size increases from 24x24 to 48x32 (rectangular). The ferry icon is designed as part of the icon set for future integration (MBTA route type 4) but is not wired to live data in this work.

## Acceptance Criteria

### icons.AC1: Vehicle Icon Silhouettes

- **icons.AC1.1 Success:** Green Line vehicles (type 0) display a trolley/streetcar silhouette with pantograph pole, rounded body, and windows
- **icons.AC1.2 Success:** Red/Orange/Blue Line vehicles (type 1) display a subway car silhouette with boxy angular body and window band
- **icons.AC1.3 Success:** Commuter Rail vehicles (type 2) display a commuter rail coach silhouette with taller body, engine nose, and horizontal stripe
- **icons.AC1.4 Success:** Bus vehicles (type 3) display a bus silhouette with rounded top, large windshield, and wheel wells
- **icons.AC1.5 Success:** Ferry icon (type 4) exists in codebase with boat hull and cabin silhouette, ready for future integration
- **icons.AC1.6 Success:** Each of the five icon types is visually distinguishable from the others at 32px height on dark map background
- **icons.AC1.7 Edge:** Unknown route types (no match in routeTypeMap) fall back to bus icon as default

### icons.AC2: Route Color Fill

- **icons.AC2.1 Success:** Vehicle body shape is filled with the route color (from routeColorMap, including theme-darkened colors for heavy rail and commuter rail)
- **icons.AC2.2 Success:** Accent details (windows, wheels, structural lines) use fixed colors (white/gray/dark) that contrast with route color on dark background
- **icons.AC2.3 Success:** Icons are clearly visible and recognizable against the dark CartoDB basemap at all zoom levels
- **icons.AC2.4 Edge:** Fallback color (#888888) produces a recognizable icon when route color is unavailable

### icons.AC3: Directional Rotation

- **icons.AC3.1 Success:** Icons face the direction of vehicle travel (front of vehicle points in bearing direction)
- **icons.AC3.2 Success:** Default icon orientation faces right (east); bearing 90 degrees results in no rotation
- **icons.AC3.3 Success:** Vehicle heading left (bearing 180-360) is rendered with horizontal flip (scaleX -1) so wheels remain on bottom
- **icons.AC3.4 Success:** Vehicle heading right (bearing 0-180) is rendered with standard rotation, wheels remain on bottom
- **icons.AC3.5 Success:** Rotation transitions smoothly during vehicle animation (no visual jump when crossing the flip boundary)
- **icons.AC3.6 Edge:** Bearing of 0 (due north) renders vehicle tilted up-right with wheels on the right side
- **icons.AC3.7 Edge:** Bearing of exactly 180 renders consistently (at the flip boundary)
- **icons.AC3.8 Failure:** Missing bearing data (null/undefined) defaults to 90 degrees (facing right, no rotation)

### icons.AC4: Marker Sizing

- **icons.AC4.1 Success:** Marker size changes from 24x24 square to 48x32 rectangular (width x height)
- **icons.AC4.2 Success:** Icon anchor point is centered at [24, 16] so vehicle position dot is at center of icon
- **icons.AC4.3 Success:** SVG viewBox uses wider-than-tall proportions matching the marker aspect ratio
- **icons.AC4.4 Success:** All five icon types fit within the same viewBox dimensions for consistent sizing
- **icons.AC4.5 Edge:** Popup hover/tap target area covers the full rectangular marker bounds

### icons.AC5: Icon Module Architecture

- **icons.AC5.1 Success:** SVG icon artwork is stored in a dedicated module (`src/vehicle-icons.js`), separate from rendering logic in map.js
- **icons.AC5.2 Success:** `vehicle-icons.js` exports a mapping of route type to SVG content — pure data, no logic, no dependencies
- **icons.AC5.3 Success:** Changing an icon requires editing only `vehicle-icons.js` — no changes to map.js or any other module
- **icons.AC5.4 Success:** The module exports a default/fallback icon for unknown route types
- **icons.AC5.5 Edge:** Adding a new vehicle type icon requires only adding a new entry to the icon module export

### icons.AC6: Cross-Cutting

- **icons.AC6.1 Success:** Existing vehicle animation (interpolation, viewport culling, fade-in/fade-out) works with new icons
- **icons.AC6.2 Success:** Visibility toggle (show/hide routes) works correctly with new icon markers
- **icons.AC6.3 Success:** Vehicle hover popups continue to work with new rectangular markers
- **icons.AC6.4 Success:** Mobile touch targets remain adequate with new marker size
- **icons.AC6.5 Success:** No performance degradation with more complex SVG paths (five distinct icon types vs one shared arrow)
- **icons.AC6.6 Failure:** If SVG path rendering fails, vehicle falls back to current arrow polygon

## Existing Patterns

### Marker Architecture (map.js)

Vehicle markers use Leaflet's `L.divIcon` with inline HTML. The rendering chain:

1. `getVehicleIconHtml(vehicle)` — returns HTML string with SVG content, route type CSS class, and route color
2. `createVehicleDivIcon(vehicle)` — wraps HTML in `L.divIcon` with size and anchor
3. `createVehicleMarker(vehicle)` — creates `L.marker`, applies rotation via CSS transform on `.vehicle-marker` div
4. `updateVehicleMarker(vehicle)` — updates position and rotation on existing markers

Rotation is applied as `iconElement.style.transform = rotate(${vehicle.bearing}deg)` at lines 178 and 205.

Route type is determined by `routeTypeMap.get(vehicle.routeId)` which maps: 0=light rail, 1=heavy rail, 2=commuter rail, 3=bus.

### CSS Structure (styles.css)

`.vehicle-marker` at line 59: 24x24px, pointer-events auto, 200ms opacity transition.

Route color is applied directly via SVG `fill` attribute (not CSS variable for the fill — `--route-color` is set but the polygon uses direct `fill="${routeColor}"`).

### Pure Functions (vehicle-math.js)

Contains exported math utilities: `lerp`, `easeOutCubic`, `lerpAngle`, `haversineDistance`, `darkenHexColor`. The rotation transform function would fit naturally here as a new export.

## Architecture

### Icon Module (`src/vehicle-icons.js`)

A dedicated ES6 module that exports SVG content strings — pure data, no logic, no dependencies. Separated from map.js so icon artwork can be iterated on (or swapped for seasonal variants) without touching rendering code.

```
src/vehicle-icons.js  ← Pure data: SVG strings per vehicle type
         ↓ import
src/map.js            ← Rendering logic: reads icon data, builds DivIcon
```

```javascript
// src/vehicle-icons.js

/** SVG content for each MBTA vehicle type. Keys match route type numbers. */
export const VEHICLE_ICONS = {
    0: `<path d="..." />...`, // Trolley (Green Line)
    1: `<path d="..." />...`, // Subway car (Red/Orange/Blue)
    2: `<path d="..." />...`, // Commuter rail coach
    3: `<path d="..." />...`, // Bus
    4: `<path d="..." />...`, // Ferry (future)
};

export const DEFAULT_ICON = VEHICLE_ICONS[3]; // Bus fallback for unknown types
```

In `map.js`, `getVehicleIconHtml()` imports from the icon module and interpolates the route color into the SVG template. The icon SVG uses placeholder tokens (e.g., `ROUTE_COLOR`) or `currentColor` that get replaced/set at render time.

**Seasonal variants:** To add holiday icons, create `src/vehicle-icons-holiday.js` with the same export shape, and change the import in map.js. Or, use a config flag to select the icon set at runtime.

### Rotation Transform

New pure function in `vehicle-math.js`:

```javascript
export function bearingToTransform(bearing) {
    // Normalize bearing to 0-360
    const b = ((bearing % 360) + 360) % 360;
    if (b <= 180) {
        // Heading rightward: rotate only
        return { rotate: b - 90, scaleX: 1 };
    } else {
        // Heading leftward: flip + adjusted rotation
        return { rotate: -(b - 270), scaleX: -1 };
    }
}
```

Applied in `createVehicleMarker` and `updateVehicleMarker` as:
```javascript
const { rotate, scaleX } = bearingToTransform(vehicle.bearing);
iconElement.style.transform = `scaleX(${scaleX}) rotate(${rotate}deg)`;
```

### Marker Dimensions

`createVehicleDivIcon` changes from `[24, 24]` / `[12, 12]` anchor to `[48, 32]` / `[24, 16]` anchor.

CSS `.vehicle-marker` changes from `24px` x `24px` to `48px` x `32px`.

SVG `viewBox` changes from `0 0 24 24` to `0 0 48 32` (or equivalent proportional viewBox).

## Implementation Phases

### Phase 1: Icon Module and SVG Artwork
Create `src/vehicle-icons.js` with the five SVG silhouettes. Design each icon with route-color body fill and fixed accent details. Establish the viewBox, color token approach, and export shape.

### Phase 2: Rendering Integration and Marker Sizing
Update `getVehicleIconHtml()` in map.js to import from vehicle-icons.js and render type-specific icons. Update `createVehicleDivIcon()` to 48x32 rectangular markers. Update CSS `.vehicle-marker` dimensions.

### Phase 3: Directional Rotation
Add `bearingToTransform()` to vehicle-math.js. Update rotation logic in `createVehicleMarker` and `updateVehicleMarker` to use the rotate+flip approach. Handle edge cases (null bearing, boundary at 180 degrees).

### Phase 4: Polish and Verification
Verify cross-cutting concerns (animation, popups, visibility toggles, mobile touch targets, performance). Test flip boundary smoothness. Update contracts in src/CLAUDE.md.

## Additional Considerations

### SVG Path Design

Icons should be designed with these constraints:
- Viewable at 32px height (48px wide) on dark background
- Body shape is the primary filled area (route color)
- Windows rendered as lighter cutouts or semi-transparent overlays
- Wheels as small circles in dark gray
- Minimal stroke lines — rely on filled shapes for clarity at small size
- Each icon must be visually distinct from every other icon at map zoom levels 10-18

### Performance

The current single arrow polygon is ~50 bytes of SVG. Five distinct icon types with more detail may be 200-400 bytes each. With potentially hundreds of vehicles visible, this is still negligible (~100KB worst case, all in JS strings, no network requests).

### Flip Boundary Smoothness (icons.AC3.5)

When a vehicle crosses the 180-degree bearing boundary, it flips horizontally. This could appear jarring if it happens during smooth animation. The `transition` CSS property on transform can soften this, but a scaleX flip mid-animation may still look odd. Implementation should test this and determine if a CSS transition duration is needed or if the flip is fast enough to be imperceptible.

### Ferry Icon (Future-Proofing)

The ferry icon is stored in `VEHICLE_ICONS[4]` matching MBTA route type 4 (ferry). It will be rendered when ferry route data is added to the SSE stream and route type map in a future feature. No additional wiring is needed — the existing `getVehicleIconHtml()` type-switching logic will automatically pick it up when `routeTypeMap` contains type 4 entries.

### Icon Module as Design System Foundation

The `vehicle-icons.js` module establishes a pattern for managing visual assets in T-Tracker without a build step. This same pattern could extend to other visual elements (stop markers, route badges, etc.) as the app grows. The key property: **artwork is data, not code** — it lives in its own module with no logic, making it safe to iterate on without regression risk.

## Glossary

| Term | Definition |
|------|-----------|
| **Bearing** | Vehicle heading in degrees (0-360), where 0=north, 90=east, 180=south, 270=west. Provided by MBTA API. |
| **DivIcon** | Leaflet's `L.divIcon` — a marker icon built from an HTML/CSS div instead of an image file. |
| **Pantograph** | The arm on top of a trolley/streetcar that connects to overhead power wires. Distinctive visual feature of Green Line vehicles. |
| **Route type** | MBTA classification: 0=light rail, 1=heavy rail, 2=commuter rail, 3=bus, 4=ferry. Stored in `routeTypeMap`. |
| **ViewBox** | SVG attribute defining the coordinate system for the icon artwork. Using `0 0 48 32` gives a wider-than-tall canvas. |
| **Icon module** | `src/vehicle-icons.js` — a pure-data ES6 module exporting SVG strings per vehicle type. No logic, no dependencies. |
